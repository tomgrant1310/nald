(function(d){var a=Drupal.menuLayout;var c=Drupal.styleHtml;var b=Drupal.menuItem;var e={tabs:null,tab_counter:d("ul li.tab-item").length+1,dlg_itemsettings:null,init:function(){d(".md-tabs-head li").live("mouseenter",function(){d(this).find(".ui-icon-close").show()}).live("mouseleave",function(){d(this).find(".ui-icon-close").hide()});d(".md-tabs-head span.ui-icon-close").live("click",function(){var f=this;var n=d(this).prev("a").attr("href");var k=d("input.settings",d(n)).val();k=d.stringToObject(k);if(!confirm("Are you sure to delete this tab?")){return}var m=d(n).find(".block-item");for(var j=0;j<m.length;j++){var l=m[j];var h=d.unserialize(d(l).find("input[type=hidden]").val()).block_module;d("#"+h).append(l)}if(k.tab_id==0){var g=d("li",e.tabs).index(d(this).parent());e.tabs.tabs("remove",g)}else{d.ajax({url:Drupal.settings.basePath+"?q=admin/structure/md-megamenu/delete-tab",type:"POST",data:{tab:k.tab_id,token_value:d("input#delete_tab_token").val()},dataType:"json",success:function(o){if(o.message=="OK"){var i=d("li",e.tabs).index(d(f).parent());e.tabs.tabs("remove",i)}}})}});e.dlg_itemsettings=d("#dlg-mnuitemsetting").dialog({resizable:false,autoOpen:false,draggable:false,modal:true,width:1000,open:function(){var g=d(this).data("settings");var f=d.stringToObject(g);if(f!=null){e.setMenuFormVal(f)}else{var h=d("form",e.dlg_itemsettings)[0];h.reset();d(h).find("input[type=hidden]").each(function(){this.value=""});d(h).find(".image-preview").empty()}d(".md-subtabs").tabs("select",0);d("#mnu_title",e.dlg_itemsettings).focus();d("#title_enabled").trigger("change")},close:function(){d("form",e.dlg_itemsettings)[0].reset();c.hide()}});d("#add_tab").click(function(){e.dlg_itemsettings.data("settings",null).data("id",null).dialog({title:"Add new menu item",buttons:{Add:function(){e.addTab();d(this).dialog("close")},Cancel:function(){d(this).dialog("close")}}}).dialog("open");return false});d(".mnu-settings").live("click",function(){var f=d(this).parent().find("input.settings").val();var g=d(this).parent().parent().attr("id");e.dlg_itemsettings.data("settings",f).data("id",g).dialog({title:"Menu item data",buttons:{Save:function(){if(d("#form-mnuitemsetting").valid()){var h=d(this).data("id");var i=e.getMenuFormVal();e.updateTabSetting(h,i);d(this).dialog("close")}},Cancel:function(){d(this).dialog("close")}}}).dialog("open");d("#submnu_full_width").trigger("change");return false});d("#form-mnuitemsetting").validate();d("#blocklist").tabs();d("#mni-subtabs").tabs({select:function(f,g){c.hide()}});d(".md-listleft a").click(function(){d(this).parent().parent().find("a").removeClass("border-white");d(this).parent().prev().find("a").addClass("border-white")});d(".md-listleft li.ui-state-active").each(function(){d(this).prev().find("a").addClass("border-white")});d("#md-subtabs .itemcol").click(function(){d("#md-subtabs .itemcol").removeClass("selected");d(this).addClass("selected")});d(".el-block").live({mouseenter:function(){d(this).addClass("el-hover")},mouseleave:function(){d(this).removeClass("el-hover")}});dlg_mmsettings=d("#dlg-mmsetting").dialog({resizable:false,autoOpen:false,draggable:false,modal:true,width:680,buttons:{OK:function(){d(this).dialog("close")}},open:function(){jQuery(".ui-widget-overlay").bind("click",function(){dlg_mmsettings.dialog("close")})}});d("#megamenu-setting").live("click",function(){dlg_mmsettings.dialog("open");return false});d("#title_enabled").change(function(){if(d(this).is(":checked")){d("#mnu_title").attr("disabled",false)}else{d("#mnu_title").attr("disabled",true)}});e.flyoutItem=d("#dlg-flyout-item").dialog({resizable:false,autoOpen:false,draggable:false,modal:true,width:600,buttons:{OK:function(){$item=d(this).data("item");var f=e.getFormVal(d("#dlg-flyout-item form"));title=f.a_title!==undefined?f.a_title:"";d(">dl >dt >a.sm2_title",$item).html(title);$item.children("input.setting").val(d.objectToString(f));if(!$item.hasClass("ei-processed")){$item.addClass("ei-processed")}d(this).dialog("close")},Cancel:function(){d(this).dialog("close")}},close:function(){$item=d(this).data("item");if($item!=null&&!$item.hasClass("ei-processed")){$item.remove()}}});d("#md-tabs").find("div.tree > ul").megadrupalTreeMenu();d("a.mnu-addnewlink").live("click",function(){newli=d(Drupal.flyMenuItem);$tree=d(this).parent().prev("div.tree");d("> ul",$tree).append(newli).megadrupalTreeMenu();newli.find("a.fly-item-edit").trigger("click")});d("a.fly-item-edit").live("click",function(){item=d(this).parent().parent().parent();var f=d.stringToObject(item.find("input.setting").val());d("#dlg-flyout-item").loadingDialog();d("#dlg-flyout-item").dialog("open");if(d("> ul > li",item).length){if(f.a_submenu_width===undefined){f.a_submenu_width=""}}else{delete f.a_submenu_width}d.post(Drupal.settings.basePath+"?q=admin/structure/md-megamenu/essential-item",f,function(g){d("#dlg-flyout-item").html(g);e.flyoutItem.data("item",item).unLoadingDialog()});return false});d("a.fly-item-delete").live("click",function(){d(this).parent().parent().parent().remove()});e.tabs=d("#md-tabs")},initTab:function(){e.tabs.tabs({cookie:{expires:1},tabTemplate:'<li class="tab-item clearfix"><a class="tab-link" href="#{href}"><span class="tab-text">#{label}</span></a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>',add:function(f,g){d(g.panel).append('<div class="settings"><a href="#" class="mnu-settings">[settings]</a><input autocomplete="off" type="hidden" class="settings" /></div><div class="md-menudropdown clearfix"><div class="tree"></div><div class="dropdown-addnew"><a href="#" class="mnu-addnewlink">[add new link]</a></div></div><div class="md-menuwrap md-1col1 clearfix"></div>');e.tabs.tabs("select",g.index)},remove:function(f,g){d(g.panel).find("div.md-bl").each(function(){var h=d.unserialize(d(this).find("input.setting").val());if(h.type.substr(0,5)=="block"){d("#blocks").append(d(this))}})}});this.sortTab()},removeIcon:function(f){d("#icon_url").val("").change()},sortTab:function(){e.tabs.find(".ui-tabs-nav").sortable({axis:"x",stop:function(){e.tabs.tabs("refresh")}})},addTab:function(){var g=d("#mnu_title").val()||"Tab "+e.tab_counter;var f="tabs-"+e.tab_counter;e.tabs.tabs("add","#tabs-"+e.tab_counter,g);e.updateTabSetting(f,e.getMenuFormVal());e.tab_counter++},getSelectedTabIndex:function(){return e.tabs.tabs("option","selected")},updateTabSetting:function(g,i){if(i.item_position=="right"){d("ul.md-tabs-head > li.tab-item.ui-state-active").addClass("mm-item-right")}else{d("ul.md-tabs-head > li.tab-item.ui-state-active").removeClass("mm-item-right")}if(i.mnu_fly_type){d("#"+g).find("div.md-menuwrap").hide();if(i.title_enabled){d('a[href$="#'+g+'"] .tab-text').html(i.mnu_title)}else{d('a[href$="#'+g+'"] .tab-text').html("")}$menuflyout=d("#"+g).find("div.md-menudropdown");$tree=$menuflyout.show().find(".tree");if($tree.is(":empty")){$tree.html("<ul></ul>");d("> ul",$tree).megadrupalTreeMenu()}d("#"+g).find("input.settings").val(d.objectToString(i))}else{d("#"+g).find("div.md-menudropdown").hide();d("#"+g).find("div.md-menuwrap").show();if(i.title_enabled){d('a[href$="#'+g+'"] .tab-text').html(i.mnu_title)}else{d('a[href$="#'+g+'"] .tab-text').html("")}var f=d('a[href$="#'+g+'"] img');if(d("#dmg-menuicon").is(":checked")&&i.icon_url&&i.icon_url!=""){if(f.length>0){f.attr("src",i.icon_url)}else{d('a[href$="#'+g+'"]').prepend('<img width="16" height="16" src="'+i.icon_url+'">')}}else{if(f.length){f.remove()}}d("#"+g).find("input.settings").val(d.objectToString(i));var h=d("#"+g).find(".md-menuwrap");var l=i.mnu_layout;var k=h.find(".md-col");if(k.length==0){e.changeLayout(h,l)}else{oldColContent=[];d.each(k,function(m,n){oldColContent.push(d(n).find(".inner").html())});e.changeLayout(h,l);var j=h.find(".md-col");d.each(oldColContent,function(m,n){if(m<j.length){d(j[m]).find(".inner").html(n)}else{d(j[j.length-1]).find(".inner").append(n)}})}b.mdcolsort()}},changeLayout:function(f,g){f.removeClass("fluid_mmcontainer_12 fluid_mmcontainer_16").addClass("fluid_mmcontainer_"+g.numCol);f.html(e.getMenuTabHtml(g.setting,g.numCol))},getMenuTabHtml:function(n,h){var m="";n=(typeof n=="string")?d.stringToObject(n):n;if(n.length>0){for(var l=0;l<n.length;l++){var f=n[l];m+='<div class="md-row clearfix">';for(var k=0;k<f.cols.length;k++){var g=parseInt(f.cols[k].length*h/48);m+='<div class="md-col {grid}"><div class="inner ui-sortable"></div></div>'.replace("{grid}","mmg_"+g)}m+="</div>"}}return m},getMenuFormVal:function(){var f=a.getLayoutConfig();return{mnu_fly_type:d('#dlg-mnuitemsetting input[name="mnu_type"]').is(":checked")?false:true,item_position:d("#dlg-mnuitemsetting #item-position").val(),submenu_fullwidth:d('#dlg-mnuitemsetting input[name="submenu_fullwidth"]').is(":checked"),submenu_width:d('#dlg-mnuitemsetting input[name="submenu_width"]').val(),hide_when_logged_in:d('#dlg-mnuitemsetting input[name="hide_logged_in"]').is(":checked"),title_enabled:d('#dlg-mnuitemsetting input[name="title_enabled"]').is(":checked")?true:false,mnu_title:d('#dlg-mnuitemsetting input[name="mnu_title"]').val(),mnu_path:d('#dlg-mnuitemsetting input[name="mnu_path"]').val(),icon_url:d('#dlg-mnuitemsetting input[name="icon_url"]').val(),mnu_desc:d('#dlg-mnuitemsetting textarea[name="mnu_desc"]').val(),mnu_class:d('#dlg-mnuitemsetting input[name="mnu_class"]').val(),mnu_id:d("input[name=menu_id]").val(),tab_id:d("#mnu_tab_id").val(),mnu_layout:f}},setMenuFormVal:function(h){d("#dlg-mnuitemsetting input[name=submenu_fullwidth]").attr("checked",h.submenu_fullwidth).trigger("change");d("#dlg-mnuitemsetting input[name=mnu_type]").attr("checked",!h.mnu_fly_type).trigger("change");d("#dlg-mnuitemsetting input[name=submenu_width]").val(h.submenu_width);d("#dlg-mnuitemsetting input[name=hide_logged_in]").attr("checked",h.hide_when_logged_in);d("#dlg-mnuitemsetting #item-position option[value="+h.item_position+"]").attr("selected","selected"),d("#dlg-mnuitemsetting input[name=mnu_title]").val(h.mnu_title);d('#dlg-mnuitemsetting input[name="mnu_path"]').val(h.mnu_path);d('#dlg-mnuitemsetting textarea[name="mnu_desc"] ').val(h.mnu_desc);d('#dlg-mnuitemsetting input[name="icon_url"]').val(h.icon_url);a.applyLayoutConfig(h.mnu_layout);d('#dlg-mnuitemsetting input[name="mnu_class"]').val(h.mnu_class);d('#dlg-mnuitemsetting input[name="dms-bgc"]').val(h.smn_bgc);d('#dlg-mnuitemsetting input[name="dms-bow"]').val(h.smn_bow);d('#dlg-mnuitemsetting select[name="dms-bos"]').val(h.smn_bos);d('#dlg-mnuitemsetting input[name="dms-boc"]').val(h.smn_boc);d("#mnu_tab_id").val(h.tab_id);if(h.icon_url!=null&&h.icon_url!=""){var g=h.icon_url.split("&")[1];g=g.split("=")[1];var f=d("<img/>").attr("src",g);d("#dlg-mnuitemsetting .image-preview").empty().append(f)}},getFormVal:function(f){var g={};d("input, select, textarea",d(f)).each(function(){g[d(this).attr("name")]=d(this).val()});return g}};Drupal.menuTab=e})(jQuery);